<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />
    <title>Aquarium Cycling Tracker</title>
    <script src="data/optimal.js"></script>
    <style>
      /* Parameter status background helpers (light shades so text stays readable) */
      .param-ok {
        background-color: #d1fae5 !important;
      } /* green-100 */
      .param-acceptable {
        background-color: #fef9c3 !important;
      } /* yellow-100 */
      .param-elevated {
        background-color: #fde68a !important;
      } /* amber-200 */
      .param-warning {
        background-color: #fcd34d !important;
      } /* amber-300 */
      .param-danger {
        background-color: #fecaca !important;
      } /* red-200 */
      .param-unknown,
      .param-invalid {
        background-color: #e5e7eb !important;
      } /* gray-200 */

      /* Transition for subtle feedback */
      #dataTable td {
        transition: background-color 0.4s ease;
      }
    </style>
  </head>
  <body
    class="font-sans bg-slate-50 m-0 p-5 min-h-screen leading-normal md:p-2.5"
  >
    <div
      id="app"
      class="w-[80vw] mx-auto bg-white border border-slate-200 shadow-sm p-8 md:p-5"
      v-cloak
    >
      <h1
        class="text-slate-800 text-center mb-8 text-4xl font-bold md:text-3xl"
      >
        Aquarium Cycling Data Tracker
      </h1>

      <!-- Tank Selection / Multi-Tank Support -->
      <div class="bg-indigo-50 border border-indigo-200 p-4 mb-6 flex flex-wrap gap-4 items-end">
        <div>
          <label class="block text-xs font-semibold text-slate-600 mb-1">Active Tank</label>
          <select v-model="currentTank" class="px-3 py-2 border border-slate-300 text-sm bg-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 min-w-48">
            <option v-for="t in tankList" :key="t" :value="t">{{ t }}</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-600 mb-1">New Tank Name</label>
          <input v-model="newTankName" placeholder="e.g., 20g QT" class="px-3 py-2 border border-slate-300 text-sm bg-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" />
        </div>
        <button @click="addTank" class="h-10 px-4 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold rounded-md">Add Tank</button>
        <button @click="duplicateTank" class="h-10 px-4 bg-slate-600 hover:bg-slate-700 text-white text-sm font-semibold rounded-md" :disabled="!currentTank">Duplicate Tank</button>
        <button @click="deleteTank" class="h-10 px-4 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold rounded-md" :disabled="tankList.length<=1">Delete Tank</button>
        <div class="ml-auto flex gap-2 items-center text-xs text-slate-600">
          <span class="font-semibold">Namespace:</span>
          <code class="bg-white px-2 py-1 border border-slate-200 rounded">{{ tankStorageNamespace }}</code>
        </div>
      </div>

      <div class="bg-slate-50 border border-slate-200 p-6 mb-8">
        <h3 class="m-0 mb-4 text-slate-700 text-xl font-semibold">
          Tank Setup Information
        </h3>
        <span class="text-gray-800 font-semibold">Tank:</span> 37 Gallon Tall |
        <span class="text-gray-800 font-semibold">Temperature:</span> 82°F |
        <span class="text-gray-800 font-semibold">Filter:</span> Full Blast |
        <span class="text-gray-800 font-semibold">Substrate:</span> Fluval Plant
        & Shrimp Stratum<br />
        <span class="text-gray-800 font-semibold">Start Date:</span> Thursday
        Sept 18th (Day 1) |
        <span class="text-gray-800 font-semibold">Location:</span> Ottawa, ON |
        <span class="text-gray-800 font-semibold">Pre-filtered:</span> 20-micron
        + KDF |
        <span class="text-gray-800 font-semibold">Bacteria Added:</span> Live
        Nitrifying Bacteria
      </div>

      <div class="bg-slate-50 border border-slate-200 p-6 mb-8">
        <h4 class="m-0 mb-5 text-slate-700 text-xl font-semibold">
          Nitrogen Cycle Phases
        </h4>
        <div class="flex gap-5 mb-5 flex-wrap justify-center md:justify-start">
          <div
            class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 font-medium"
          >
            <div class="w-4 h-4 bg-red-600"></div>
            <span>Ammonia (NH₃)</span>
          </div>
          <div
            class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 font-medium"
          >
            <div class="w-4 h-4 bg-orange-600"></div>
            <span>Nitrite (NO₂⁻)</span>
          </div>
          <div
            class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 font-medium"
          >
            <div class="w-4 h-4 bg-green-600"></div>
            <span>Nitrate (NO₃⁻)</span>
          </div>
          <div
            class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 font-medium"
          >
            <div class="w-4 h-4 bg-purple-600"></div>
            <span>pH</span>
          </div>
        </div>
        <span class="font-semibold">Phase 1:</span> Ammonia Processing (Days
        1-14) | <span class="font-semibold">Phase 2:</span> Nitrite Spike (Days
        14-28) | <span class="font-semibold">Phase 3:</span> Nitrate Rise &
        Completion (Days 28-42)
      </div>

      <!-- Parameter & Phase Legend -->
      <div class="bg-white border border-slate-200 p-4 mb-10 text-sm leading-5">
        <h5 class="m-0 mb-3 font-semibold text-slate-700 text-base">Legend</h5>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <p class="m-0 mb-2 font-medium text-slate-600">
              Parameter Status Colors
            </p>
            <ul class="m-0 p-0 list-none space-y-1">
              <li class="flex items-center gap-2">
                <span
                  class="inline-block w-4 h-4 rounded-sm border border-slate-300 param-ok"
                ></span
                ><span>Optimal / Preferred range</span>
              </li>
              <li class="flex items-center gap-2">
                <span
                  class="inline-block w-4 h-4 rounded-sm border border-slate-300 param-acceptable"
                ></span
                ><span>Acceptable (monitor)</span>
              </li>
              <li class="flex items-center gap-2">
                <span
                  class="inline-block w-4 h-4 rounded-sm border border-slate-300 param-elevated"
                ></span
                ><span>Elevated (investigate soon)</span>
              </li>
              <li class="flex items-center gap-2">
                <span
                  class="inline-block w-4 h-4 rounded-sm border border-slate-300 param-warning"
                ></span
                ><span>Warning (action likely needed)</span>
              </li>
              <li class="flex items-center gap-2">
                <span
                  class="inline-block w-4 h-4 rounded-sm border border-slate-300 param-danger"
                ></span
                ><span>Danger (take action)</span>
              </li>
            </ul>
          </div>
          <div>
            <p class="m-0 mb-2 font-medium text-slate-600">
              Phase Badge Colors
            </p>
            <ul class="m-0 p-0 list-none space-y-1">
              <li class="flex items-center gap-2">
                <span class="inline-block w-4 h-4 bg-red-600"></span
                ><span>Phase 1 – Establishing ammonia oxidizers</span>
              </li>
              <li class="flex items-center gap-2">
                <span class="inline-block w-4 h-4 bg-orange-600"></span
                ><span
                  >Phase 2 – Nitrite spike / nitrite oxidizers growing</span
                >
              </li>
              <li class="flex items-center gap-2">
                <span class="inline-block w-4 h-4 bg-green-600"></span
                ><span
                  >Phase 3 – Nitrate accumulation / nearing completion</span
                >
              </li>
            </ul>
            <p class="m-0 mt-3 text-xs text-slate-500">
              Arrows next to values show change vs previous reading (▲ up, ▼
              down, ▬ no change).
            </p>
          </div>
        </div>
      </div>

      <table
        id="dataTable"
        class="w-full border-separate border-spacing-0 mb-8 bg-white border border-slate-200 shadow-sm"
      >
        <thead>
          <tr class="bg-gray-700 text-white">
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Date
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Cycle Day
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Ammonia (ppm)
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Nitrite (ppm)
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Nitrate (ppm)
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              pH
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Temperature (°F)
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Ammonia Dosed?
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Phase
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Notes
            </th>
            <th
              class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody
          class="[&>tr:nth-child(even):not(.bg-gray-50)]:bg-gray-50 [&>tr:hover]:bg-slate-50"
        >
          <tr
            v-for="(r,i) in readings"
            :key="r.id"
            :class="[i % 2 === 1 ? 'bg-gray-50':'', 'hover:bg-slate-50']"
          >
            <td class="px-3 py-3 text-center border-b border-gray-200">
              {{ r.date }}
            </td>
            <td class="px-3 py-3 text-center border-b border-gray-200">
              {{ r.day }}
            </td>
            <td
              class="px-3 py-3 text-center border-b border-gray-200"
              :class="parameterClass(r.ammonia,'ammonia')"
            >
              {{ r.ammonia }}
              <span
                v-if="trendIcon('ammonia', i)"
                :class="['ml-1 text-xs font-semibold', trendClass('ammonia', i)]"
                >{{ trendIcon('ammonia', i) }}</span
              >
            </td>
            <td
              class="px-3 py-3 text-center border-b border-gray-200"
              :class="parameterClass(r.nitrite,'nitrite')"
            >
              {{ r.nitrite }}
              <span
                v-if="trendIcon('nitrite', i)"
                :class="['ml-1 text-xs font-semibold', trendClass('nitrite', i)]"
                >{{ trendIcon('nitrite', i) }}</span
              >
            </td>
            <td
              class="px-3 py-3 text-center border-b border-gray-200"
              :class="parameterClass(r.nitrate,'nitrate')"
            >
              {{ r.nitrate }}
              <span
                v-if="trendIcon('nitrate', i)"
                :class="['ml-1 text-xs font-semibold', trendClass('nitrate', i)]"
                >{{ trendIcon('nitrate', i) }}</span
              >
            </td>
            <td
              class="px-3 py-3 text-center border-b border-gray-200"
              :class="parameterClass(r.ph,'ph')"
            >
              {{ r.ph }}
              <span
                v-if="trendIcon('ph', i)"
                :class="['ml-1 text-xs font-semibold', trendClass('ph', i)]"
                >{{ trendIcon('ph', i) }}</span
              >
            </td>
            <td class="px-3 py-3 text-center border-b border-gray-200">
              {{ r.temp }}
            </td>
            <td class="px-3 py-3 text-center border-b border-gray-200">
              {{ r.dosed }}
            </td>
            <td class="px-3 py-3 text-center border-b border-gray-200">
              <span
                :class="['font-semibold px-3 py-1.5 text-white text-xs uppercase tracking-wider inline-block', phaseClass(r)]"
                >{{ phaseLabel(r) }}</span
              >
            </td>
            <td class="px-3 py-3 text-center border-b border-gray-200">
              {{ r.notes }}
            </td>
            <td class="px-3 py-3 text-center border-b border-gray-200">
              <button
                @click="deleteReading(i)"
                class="bg-red-600 hover:bg-red-700 text-white border-none px-2 py-1 rounded-md cursor-pointer text-xs font-medium transition-all duration-200 shadow-sm hover:-translate-y-px hover:shadow-md"
              >
                Delete
              </button>
            </td>
          </tr>
          <tr class="bg-gray-50 border-t-2 border-gray-300 bg-gradient-to-r">
            <td class="px-2 py-4">
              <input
                type="date"
                v-model="newReading.date"
                class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              />
            </td>
            <td class="px-2 py-4">
              <input
                type="number"
                v-model.number="newReading.day"
                min="1"
                class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              />
            </td>
            <td class="px-2 py-4">
              <input
                type="number"
                v-model="newReading.ammonia"
                step="0.25"
                min="0"
                placeholder="0.00"
                class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              />
            </td>
            <td class="px-2 py-4">
              <input
                type="number"
                v-model="newReading.nitrite"
                step="0.25"
                min="0"
                placeholder="0.00"
                class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              />
            </td>
            <td class="px-2 py-4">
              <input
                type="number"
                v-model="newReading.nitrate"
                step="0.25"
                min="0"
                placeholder="0.00"
                class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              />
            </td>
            <td class="px-2 py-4">
              <input
                type="number"
                v-model="newReading.ph"
                step="0.1"
                min="6"
                max="9"
                placeholder="9.0"
                class="w-full min-w-20 px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              />
            </td>
            <td class="px-2 py-4">
              <input
                type="number"
                v-model="newReading.temp"
                min="70"
                max="90"
                class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              />
            </td>
            <td class="px-2 py-4">
              <select
                v-model="newReading.dosed"
                class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              >
                <option value="No">No</option>
                <option value="Yes - 2ppm">Yes - 2ppm</option>
                <option value="Yes - 3ppm">Yes - 3ppm</option>
                <option value="Yes - 4ppm">Yes - 4ppm</option>
              </select>
            </td>
            <td class="px-2 py-4">
              <span
                :class="['font-semibold px-3 py-1.5 text-white text-xs uppercase tracking-wider inline-block', phaseClass(newReading)]"
                >{{ phaseLabel(newReading) }}</span
              >
            </td>
            <td class="px-2 py-4">
              <input
                type="text"
                v-model="newReading.notes"
                placeholder="Enter observations..."
                class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
              />
            </td>
            <td class="px-2 py-4">-</td>
          </tr>
        </tbody>
      </table>

      <!-- Chart Section -->
      <div class="bg-white border border-slate-200 p-6 mb-10">
        <h3 class="m-0 mb-4 text-slate-700 text-xl font-semibold flex items-center gap-3">
          <span>Parameter Trends</span>
          <button @click="refreshChart" class="text-xs px-3 py-1.5 bg-slate-800 text-white rounded hover:bg-slate-900">Refresh</button>
        </h3>
        <canvas id="cycleChart" height="140"></canvas>
        <p class="mt-3 text-xs text-slate-500">
          Shaded background indicates approximate nitrogen cycle phase windows (Phase 1: red, Phase 2: orange, Phase 3: green). Actual phase badges derive from readings.
        </p>
      </div>

      <button
        class="bg-blue-600 text-white px-6 py-3 border border-blue-600 cursor-pointer mx-2.5 my-2.5 font-semibold text-sm hover:bg-blue-700 hover:border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
        @click="addReading"
      >
        Add Reading
      </button>
      <button
        class="bg-blue-600 text-white px-6 py-3 border border-blue-600 cursor-pointer mx-2.5 my-2.5 font-semibold text-sm hover:bg-blue-700 hover:border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
        @click="exportToCSV"
      >
        Export to CSV
      </button>
      <button
        class="bg-blue-600 text-white px-6 py-3 border border-blue-600 cursor-pointer mx-2.5 my-2.5 font-semibold text-sm hover:bg-blue-700 hover:border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
        @click="exportToJSON"
      >
        Export JSON
      </button>
      <button
        class="bg-blue-600 text-white px-6 py-3 border border-blue-600 cursor-pointer mx-2.5 my-2.5 font-semibold text-sm hover:bg-blue-700 hover:border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
        @click="triggerImportJSON"
      >
        Import JSON
      </button>
      <input ref="importInput" type="file" accept="application/json" class="hidden" @change="handleImportJSON" />
      <button
        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 border-none rounded-xl cursor-pointer mx-2.5 my-2.5 font-semibold text-sm transition-all duration-300 shadow-lg relative overflow-hidden hover:-translate-y-0.5 hover:shadow-xl active:translate-y-0"
        @click="persistAll"
      >
        Save Data
      </button>
      <button
        class="bg-red-700 hover:bg-red-800 text-white px-6 py-3 border-none rounded-xl cursor-pointer mx-2.5 my-2.5 font-semibold text-sm transition-all duration-300 shadow-lg"
        @click="clearAll"
      >
        Clear All Data
      </button>

      <!-- Water Changes Section -->
      <div class="bg-slate-50 border border-slate-200 p-6 mb-8 mt-8">
        <h3 class="m-0 mb-4 text-slate-700 text-xl font-semibold">
          💧 Water Changes Log
        </h3>
        <table
          id="waterChangesTable"
          class="w-full border-separate border-spacing-0 mb-8 bg-white border border-slate-200 shadow-sm"
        >
          <thead>
            <tr class="bg-gray-700 text-white">
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Date
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Volume Changed
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Reason
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Impact on Cycle
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody
            class="[&>tr:nth-child(even):not(.bg-gray-50)]:bg-gray-50 [&>tr:hover]:bg-slate-50"
          >
            <tr
              v-for="(w,i) in waterChanges"
              :key="w.id"
              :class="[i % 2 === 1 ? 'bg-gray-50':'','hover:bg-slate-50']"
            >
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ w.date }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ w.volume }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ w.reason }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ w.impact }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                <button
                  @click="deleteWaterChange(i)"
                  class="bg-red-600 hover:bg-red-700 text-white border-none px-2 py-1 rounded-md cursor-pointer text-xs font-medium"
                >
                  Delete
                </button>
              </td>
            </tr>
            <tr class="bg-gray-50 border-t-2 border-gray-300">
              <td class="px-2 py-4">
                <input
                  type="date"
                  v-model="newWaterChange.date"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newWaterChange.volume"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select volume...</option>
                  <option value="25% (9.25 gal)">25% (9.25 gal)</option>
                  <option value="50% (18.5 gal)">50% (18.5 gal)</option>
                  <option value="75% (27.75 gal)">75% (27.75 gal)</option>
                  <option value="Custom">Custom</option>
                </select>
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newWaterChange.reason"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select reason...</option>
                  <option value="Nitrite spike >5ppm">
                    Nitrite spike >5ppm
                  </option>
                  <option value="Regular maintenance">
                    Regular maintenance
                  </option>
                  <option value="Ammonia too high">Ammonia too high</option>
                  <option value="pH adjustment needed">
                    pH adjustment needed
                  </option>
                  <option value="Emergency">Emergency</option>
                  <option value="Other">Other</option>
                </select>
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newWaterChange.impact"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select impact...</option>
                  <option value="Minimal - cycle continues">
                    Minimal - cycle continues
                  </option>
                  <option value="Moderate - some bacterial loss">
                    Moderate - some bacterial loss
                  </option>
                  <option value="Significant - cycle reset">
                    Significant - cycle reset
                  </option>
                  <option value="Unknown">Unknown</option>
                </select>
              </td>
              <td class="px-2 py-4">-</td>
            </tr>
          </tbody>
        </table>
        <button
          class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-3 rounded-xl cursor-pointer mx-2.5 my-2.5 font-semibold text-sm"
          @click="addWaterChange"
        >
          Log Water Change
        </button>
      </div>

      <!-- Tank Additions/Interventions Section -->
      <div class="bg-slate-50 border border-slate-200 p-6 mb-8 mt-8">
        <h3 class="m-0 mb-4 text-slate-700 text-xl font-semibold">
          🧪 Tank Additions & Interventions
        </h3>
        <table
          id="additionsTable"
          class="w-full border-separate border-spacing-0 mb-8 bg-white border border-slate-200 shadow-sm"
        >
          <thead>
            <tr class="bg-gray-700 text-white">
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Date Added
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Product/Item
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Quantity/Dosage
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Reason
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody
            class="[&>tr:nth-child(even):not(.bg-gray-50)]:bg-gray-50 [&>tr:hover]:bg-slate-50"
          >
            <tr
              v-for="(a,i) in additions"
              :key="a.id"
              :class="[i % 2 ===1 ? 'bg-gray-50':'','hover:bg-slate-50']"
            >
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ a.date }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ a.product }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ a.quantity }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ a.reason }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                <button
                  @click="deleteAddition(i)"
                  class="bg-red-600 hover:bg-red-700 text-white border-none px-2 py-1 rounded-md text-xs"
                >
                  Delete
                </button>
              </td>
            </tr>
            <tr class="bg-gray-50 border-t-2 border-gray-300">
              <td class="px-2 py-4">
                <input
                  type="date"
                  v-model="newAddition.date"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newAddition.product"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select product...</option>
                  <option value="Bacteria dose">Bacteria dose</option>
                  <option value="pH Down">pH Down</option>
                  <option value="pH Up">pH Up</option>
                  <option value="Aquarium salt">Aquarium salt</option>
                  <option value="Water conditioner">Water conditioner</option>
                  <option value="Live plants">Live plants</option>
                  <option value="Decorations">Decorations</option>
                  <option value="Filter media">Filter media</option>
                  <option value="Activated carbon">Activated carbon</option>
                  <option value="Bio balls">Bio balls</option>
                  <option value="Other">Other</option>
                </select>
              </td>
              <td class="px-2 py-4">
                <input
                  type="text"
                  v-model="newAddition.quantity"
                  placeholder="e.g., 5ml, 1 dose, 3 plants"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newAddition.reason"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select reason...</option>
                  <option value="Boost bacterial colony">
                    Boost bacterial colony
                  </option>
                  <option value="pH adjustment">pH adjustment</option>
                  <option value="Water conditioning">Water conditioning</option>
                  <option value="Aesthetic improvement">
                    Aesthetic improvement
                  </option>
                  <option value="Biological filtration">
                    Biological filtration
                  </option>
                  <option value="Chemical filtration">
                    Chemical filtration
                  </option>
                  <option value="Emergency intervention">
                    Emergency intervention
                  </option>
                  <option value="Routine maintenance">
                    Routine maintenance
                  </option>
                  <option value="Other">Other</option>
                </select>
              </td>
              <td class="px-2 py-4">-</td>
            </tr>
          </tbody>
        </table>
        <button
          class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-xl cursor-pointer mx-2.5 my-2.5 font-semibold text-sm"
          @click="addAddition"
        >
          Log Addition
        </button>
      </div>

      <!-- Environmental Factors Section -->
      <div class="bg-slate-50 border border-slate-200 p-6 mb-8 mt-8">
        <h3 class="m-0 mb-4 text-slate-700 text-xl font-semibold">
          🌡️ Environmental Factors
        </h3>
        <table
          id="environmentalTable"
          class="w-full border-separate border-spacing-0 mb-8 bg-white border border-slate-200 shadow-sm"
        >
          <thead>
            <tr class="bg-gray-700 text-white">
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Date
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Factor Type
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Description
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Duration/Impact
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody
            class="[&>tr:nth-child(even):not(.bg-gray-50)]:bg-gray-50 [&>tr:hover]:bg-slate-50"
          >
            <tr
              v-for="(e,i) in environmentalFactors"
              :key="e.id"
              :class="[i % 2 ===1 ? 'bg-gray-50':'','hover:bg-slate-50']"
            >
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ e.date }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ e.type }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ e.description }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ e.impact }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                <button
                  @click="deleteEnvironmental(i)"
                  class="bg-red-600 hover:bg-red-700 text-white border-none px-2 py-1 rounded-md text-xs"
                >
                  Delete
                </button>
              </td>
            </tr>
            <tr class="bg-gray-50 border-t-2 border-gray-300">
              <td class="px-2 py-4">
                <input
                  type="date"
                  v-model="newEnvironmental.date"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newEnvironmental.type"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select factor...</option>
                  <option value="Room temperature change">
                    Room temperature change
                  </option>
                  <option value="Power outage">Power outage</option>
                  <option value="Equipment failure">Equipment failure</option>
                  <option value="Filter maintenance">Filter maintenance</option>
                  <option value="Filter cleaning">Filter cleaning</option>
                  <option value="Lighting change">Lighting change</option>
                  <option value="Substrate disturbance">
                    Substrate disturbance
                  </option>
                  <option value="Air pump issue">Air pump issue</option>
                  <option value="Other">Other</option>
                </select>
              </td>
              <td class="px-2 py-4">
                <input
                  type="text"
                  v-model="newEnvironmental.description"
                  placeholder="Detailed description..."
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newEnvironmental.impact"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select duration/impact...</option>
                  <option value="< 1 hour - minimal">< 1 hour - minimal</option>
                  <option value="1-4 hours - moderate">
                    1-4 hours - moderate
                  </option>
                  <option value="4-12 hours - significant">
                    4-12 hours - significant
                  </option>
                  <option value="12+ hours - major">12+ hours - major</option>
                  <option value="Ongoing">Ongoing</option>
                  <option value="Resolved">Resolved</option>
                </select>
              </td>
              <td class="px-2 py-4">-</td>
            </tr>
          </tbody>
        </table>
        <button
          class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-xl cursor-pointer mx-2.5 my-2.5 font-semibold text-sm"
          @click="addEnvironmental"
        >
          Log Environmental Factor
        </button>
      </div>

      <!-- Water Source Tracking Section -->
      <div class="bg-slate-50 border border-slate-200 p-6 mb-8 mt-8">
        <h3 class="m-0 mb-4 text-slate-700 text-xl font-semibold">
          🚰 Water Source Tracking
        </h3>
        <table
          id="waterSourceTable"
          class="w-full border-separate border-spacing-0 mb-8 bg-white border border-slate-200 shadow-sm"
        >
          <thead>
            <tr class="bg-gray-700 text-white">
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Date
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Water Batch/Source
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Treatment Changes
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Municipal Changes
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody
            class="[&>tr:nth-child(even):not(.bg-gray-50)]:bg-gray-50 [&>tr:hover]:bg-slate-50"
          >
            <tr
              v-for="(s,i) in waterSources"
              :key="s.id"
              :class="[i % 2 ===1 ? 'bg-gray-50':'','hover:bg-slate-50']"
            >
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ s.date }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ s.batch }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ s.treatment }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ s.municipal }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                <button
                  @click="deleteWaterSource(i)"
                  class="bg-red-600 hover:bg-red-700 text-white border-none px-2 py-1 rounded-md text-xs"
                >
                  Delete
                </button>
              </td>
            </tr>
            <tr class="bg-gray-50 border-t-2 border-gray-300">
              <td class="px-2 py-4">
                <input
                  type="date"
                  v-model="newWaterSource.date"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <input
                  type="text"
                  v-model="newWaterSource.batch"
                  placeholder="e.g., Batch #1, New filter"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newWaterSource.treatment"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select treatment...</option>
                  <option value="No changes">No changes</option>
                  <option value="New pre-filter installed">
                    New pre-filter installed
                  </option>
                  <option value="KDF media replaced">KDF media replaced</option>
                  <option value="Different conditioner used">
                    Different conditioner used
                  </option>
                  <option value="Filter maintenance">Filter maintenance</option>
                  <option value="Other">Other</option>
                </select>
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newWaterSource.municipal"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select municipal changes...</option>
                  <option value="No known changes">No known changes</option>
                  <option value="Seasonal adjustment">
                    Seasonal adjustment
                  </option>
                  <option value="Higher chlorine">Higher chlorine</option>
                  <option value="pH variation">pH variation</option>
                  <option value="Hardness change">Hardness change</option>
                  <option value="Ottawa water report change">
                    Ottawa water report change
                  </option>
                  <option value="Other">Other</option>
                </select>
              </td>
              <td class="px-2 py-4">-</td>
            </tr>
          </tbody>
        </table>
        <button
          class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-6 py-3 rounded-xl cursor-pointer mx-2.5 my-2.5 font-semibold text-sm"
          @click="addWaterSource"
        >
          Log Water Source
        </button>
      </div>

      <!-- Bacterial Health Indicators Section -->
      <div class="bg-slate-50 border border-slate-200 p-6 mb-8 mt-8">
        <h3 class="m-0 mb-4 text-slate-700 text-xl font-semibold">
          🦠 Bacterial Health Indicators
        </h3>
        <table
          id="bacterialHealthTable"
          class="w-full border-separate border-spacing-0 mb-8 bg-white border border-slate-200 shadow-sm"
        >
          <thead>
            <tr class="bg-gray-700 text-white">
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Date
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Water Clarity
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Surface Film
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Odor Notes
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Bio-film Formation
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody
            class="[&>tr:nth-child(even):not(.bg-gray-50)]:bg-gray-50 [&>tr:hover]:bg-slate-50"
          >
            <tr
              v-for="(b,i) in bacterialHealth"
              :key="b.id"
              :class="[i % 2 ===1 ? 'bg-gray-50':'','hover:bg-slate-50']"
            >
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ b.date }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ b.clarity }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ b.surface }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ b.odor }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ b.biofilm }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                <button
                  @click="deleteBacterial(i)"
                  class="bg-red-600 hover:bg-red-700 text-white border-none px-2 py-1 rounded-md text-xs"
                >
                  Delete
                </button>
              </td>
            </tr>
            <tr class="bg-gray-50 border-t-2 border-gray-300">
              <td class="px-2 py-4">
                <input
                  type="date"
                  v-model="newBacterial.date"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newBacterial.clarity"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select clarity...</option>
                  <option value="Crystal clear">Crystal clear</option>
                  <option value="Slightly cloudy">Slightly cloudy</option>
                  <option value="Moderately cloudy">Moderately cloudy</option>
                  <option value="Very cloudy">Very cloudy</option>
                  <option value="Bacterial bloom">Bacterial bloom</option>
                </select>
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newBacterial.surface"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select surface film...</option>
                  <option value="None">None</option>
                  <option value="Light film">Light film</option>
                  <option value="Moderate film">Moderate film</option>
                  <option value="Heavy film">Heavy film</option>
                  <option value="Oily film">Oily film</option>
                </select>
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newBacterial.odor"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select odor...</option>
                  <option value="None/neutral">None/neutral</option>
                  <option value="Earthy (healthy)">Earthy (healthy)</option>
                  <option value="Fresh water smell">Fresh water smell</option>
                  <option value="Sulfur smell">Sulfur smell</option>
                  <option value="Rotten egg smell">Rotten egg smell</option>
                  <option value="Other concerning odor">
                    Other concerning odor
                  </option>
                </select>
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newBacterial.biofilm"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select bio-film...</option>
                  <option value="None visible">None visible</option>
                  <option value="Light formation">Light formation</option>
                  <option value="Moderate formation">Moderate formation</option>
                  <option value="Heavy formation">Heavy formation</option>
                  <option value="On filter media">On filter media</option>
                  <option value="On substrate">On substrate</option>
                </select>
              </td>
              <td class="px-2 py-4">-</td>
            </tr>
          </tbody>
        </table>
        <button
          class="bg-gradient-to-r from-pink-500 to-pink-600 text-white px-6 py-3 rounded-xl cursor-pointer mx-2.5 my-2.5 font-semibold text-sm"
          @click="addBacterial"
        >
          Log Bacterial Health
        </button>
      </div>

      <!-- Critical Cycle Events Section -->
      <div class="bg-slate-50 border border-slate-200 p-6 mb-8 mt-8">
        <h3 class="m-0 mb-4 text-slate-700 text-xl font-semibold">
          ⚡ Critical Cycle Events
        </h3>
        <table
          id="criticalEventsTable"
          class="w-full border-separate border-spacing-0 mb-8 bg-white border border-slate-200 shadow-sm"
        >
          <thead>
            <tr class="bg-gray-700 text-white">
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Date
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Event Type
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Reading/Value
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Significance
              </th>
              <th
                class="font-semibold px-3 py-4 text-center text-sm sticky top-0 z-10"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody
            class="[&>tr:nth-child(even):not(.bg-gray-50)]:bg-gray-50 [&>tr:hover]:bg-slate-50"
          >
            <tr
              v-for="(c,i) in criticalEvents"
              :key="c.id"
              :class="[i % 2 ===1 ? 'bg-gray-50':'','hover:bg-slate-50']"
            >
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ c.date }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ c.eventType }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ c.reading }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                {{ c.significance }}
              </td>
              <td class="px-3 py-3 text-center border-b border-gray-200">
                <button
                  @click="deleteCritical(i)"
                  class="bg-red-600 hover:bg-red-700 text-white border-none px-2 py-1 rounded-md text-xs"
                >
                  Delete
                </button>
              </td>
            </tr>
            <tr class="bg-gray-50 border-t-2 border-gray-300">
              <td class="px-2 py-4">
                <input
                  type="date"
                  v-model="newCritical.date"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newCritical.eventType"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select event...</option>
                  <option value="First ammonia drop detected">
                    First ammonia drop detected
                  </option>
                  <option value="First nitrite appearance">
                    First nitrite appearance
                  </option>
                  <option value="Peak nitrite reading">
                    Peak nitrite reading
                  </option>
                  <option value="First nitrate detection">
                    First nitrate detection
                  </option>
                  <option value="Cycle completion test">
                    Cycle completion test
                  </option>
                  <option value="Ammonia processed in 24hrs">
                    Ammonia processed in 24hrs
                  </option>
                  <option value="Nitrite spike resolved">
                    Nitrite spike resolved
                  </option>
                </select>
              </td>
              <td class="px-2 py-4">
                <input
                  type="text"
                  v-model="newCritical.reading"
                  placeholder="e.g., 3.0 ppm, 24 hours"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                />
              </td>
              <td class="px-2 py-4">
                <select
                  v-model="newCritical.significance"
                  class="w-full px-3 py-2 border border-gray-300 text-sm bg-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select significance...</option>
                  <option value="Major milestone">Major milestone</option>
                  <option value="Phase transition">Phase transition</option>
                  <option value="Cycle progression">Cycle progression</option>
                  <option value="Potential setback">Potential setback</option>
                  <option value="Completion indicator">
                    Completion indicator
                  </option>
                </select>
              </td>
              <td class="px-2 py-4">-</td>
            </tr>
          </tbody>
        </table>
        <button
          class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl cursor-pointer mx-2.5 my-2.5 font-semibold text-sm"
          @click="addCritical"
        >
          Log Critical Event
        </button>
      </div>

      <div class="mt-10 bg-white p-6 rounded-2xl shadow-lg">
        <h3 class="text-gray-800 text-xl mb-4 font-semibold">
          Cycling Progress Notes
        </h3>
        <textarea
          id="progressNotes"
          v-model="progressNotes"
          placeholder="Track overall progress, observations, and next steps...

Key Milestones to Watch:
• Ammonia begins dropping (indicates Nitrosomonas bacteria working)
• First nitrite spike (Phase 2 beginning)
• Nitrite peak and decline (Nitrobacter bacteria establishing)
• Stable 0 ammonia, 0 nitrite with rising nitrates (cycle complete)

Target: Process 4ppm ammonia to 0 ammonia, 0 nitrite within 24 hours"
          class="w-full h-32 p-4 border-2 border-gray-300 rounded-xl resize-y font-inherit text-sm leading-6 transition-all duration-300 focus:outline-none focus:border-blue-500 focus:shadow-md"
        ></textarea>
      </div>

      <!-- Predictive Insights -->
      <div class="mt-10 bg-gradient-to-br from-slate-800 to-slate-900 text-slate-100 p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
          <span>🔮 Predictive Insights</span>
          <button @click="recomputePredictions" class="text-xs bg-slate-600 hover:bg-slate-500 px-2 py-1 rounded">Recompute</button>
        </h3>
        <div class="grid md:grid-cols-3 gap-5 text-sm">
          <div class="bg-slate-700/40 p-4 rounded">
            <h4 class="font-semibold mb-2 text-slate-200 text-xs tracking-wide uppercase">Ammonia Processing</h4>
            <p class="m-0"><span class="font-medium">Rate:</span> {{ predictions.ammonia.rateDisplay }}</p>
            <p class="m-0"><span class="font-medium">Est. Days to < 0.25:</span> {{ predictions.ammonia.daysToTargetDisplay }}</p>
            <p class="m-0"><span class="font-medium">Projected Date:</span> {{ predictions.ammonia.projectedDate || '—' }}</p>
          </div>
          <div class="bg-slate-700/40 p-4 rounded">
            <h4 class="font-semibold mb-2 text-slate-200 text-xs tracking-wide uppercase">Nitrite Resolution</h4>
            <p class="m-0"><span class="font-medium">Rate:</span> {{ predictions.nitrite.rateDisplay }}</p>
            <p class="m-0"><span class="font-medium">Est. Days to < 0.25:</span> {{ predictions.nitrite.daysToTargetDisplay }}</p>
            <p class="m-0"><span class="font-medium">Projected Date:</span> {{ predictions.nitrite.projectedDate || '—' }}</p>
          </div>
          <div class="bg-slate-700/40 p-4 rounded">
            <h4 class="font-semibold mb-2 text-slate-200 text-xs tracking-wide uppercase">Nitrate Accumulation</h4>
            <p class="m-0"><span class="font-medium">Rate:</span> {{ predictions.nitrate.rateDisplay }}</p>
            <p class="m-0"><span class="font-medium">Est. +10 ppm in:</span> {{ predictions.nitrate.daysToPlus10Display }}</p>
            <p class="m-0"><span class="font-medium">Projected 10ppm Date:</span> {{ predictions.nitrate.projectedDate || '—' }}</p>
          </div>
        </div>
        <p class="mt-4 text-[11px] text-slate-400">Estimates use simple linear regression on recent valid points (last 5–10). Real biological cycles are non-linear; treat as guidance only.</p>
      </div>

      <!-- Undo Snackbar -->
      <transition name="fade">
        <div v-if="undo.visible" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-3 rounded-full shadow-lg flex items-center gap-4 text-sm z-50">
          <span>{{ undo.message }}</span>
          <button @click="performUndo" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-500 rounded text-xs font-semibold">Undo</button>
          <button @click="dismissUndo" class="px-2 py-1 text-slate-300 hover:text-white">✕</button>
        </div>
      </transition>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            // Tanks
            tankList: [],
            currentTank: '',
            newTankName: '',
            tankStorageNamespace: '',
            // Core readings
            readings: [],
            newReading: {
              date: "",
              day: 1,
              ammonia: "",
              nitrite: "",
              nitrate: "",
              ph: "",
              temp: 82,
              dosed: "No",
              notes: "",
            },
            progressNotes: "",
            // Logs
            waterChanges: [],
            newWaterChange: { date: "", volume: "", reason: "", impact: "" },
            additions: [],
            newAddition: { date: "", product: "", quantity: "", reason: "" },
            environmentalFactors: [],
            newEnvironmental: {
              date: "",
              type: "",
              description: "",
              impact: "",
            },
            waterSources: [],
            newWaterSource: {
              date: "",
              batch: "",
              treatment: "",
              municipal: "",
            },
            bacterialHealth: [],
            newBacterial: {
              date: "",
              clarity: "",
              surface: "",
              odor: "",
              biofilm: "",
            },
            criticalEvents: [],
            newCritical: {
              date: "",
              eventType: "",
              reading: "",
              significance: "",
            },
            // LocalStorage keys (dynamic per tank)
            lsKeys: {},
            // Undo buffer
            undo: {
              visible: false,
              timeoutId: null,
              payload: null,
              message: '',
              ttl: 8000,
            },
            // Chart instance
            chart: null,
            // Predictive data
            predictions: {
              ammonia: {},
              nitrite: {},
              nitrate: {},
            },
          };
        },
        mounted() {
          this.initTanks();
          this.$nextTick(() => {
            this.setupChart();
            this.updateChart();
            this.recomputePredictions();
          });
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(()=>{});
          }
        },
        watch: {
          readings: {
            deep: true,
            handler() {
              this.persistReadings();
              this.updateChart();
              this.recomputePredictions();
            },
          },
          progressNotes(value) {
            localStorage.setItem(this.lsKeys.notes, value);
          },
          waterChanges: {
            deep: true,
            handler() {
              this.persistWater();
            },
          },
          additions: {
            deep: true,
            handler() {
              this.persistAdditions();
            },
          },
          environmentalFactors: {
            deep: true,
            handler() {
              this.persistEnv();
            },
          },
          waterSources: {
            deep: true,
            handler() {
              this.persistSource();
            },
          },
          bacterialHealth: {
            deep: true,
            handler() {
              this.persistBacterial();
            },
          },
          criticalEvents: {
            deep: true,
            handler() {
              this.persistCritical();
            },
          },
          currentTank(newVal, oldVal) {
            if (newVal && newVal !== oldVal) {
              this.updateNamespace();
              this.loadAll();
              this.$nextTick(() => {
                this.updateChart();
                this.recomputePredictions();
              });
            }
          }
        },
        methods: {
          // Utility
          today() {
            return new Date().toISOString().split("T")[0];
          },
          formatDate(d) {
            return d.toISOString().split("T")[0];
          },
          resetNewReading() {
            const lastDay = this.readings.length
              ? Number(this.readings[this.readings.length - 1].day) ||
                this.readings.length
              : 0;
            const lastDate = this.readings.length
              ? new Date(this.readings[this.readings.length - 1].date)
              : new Date();
            if (this.readings.length) {
              lastDate.setDate(lastDate.getDate() + 1);
            }
            this.newReading = {
              date: this.formatDate(lastDate),
              day: lastDay + 1,
              ammonia: "",
              nitrite: "",
              nitrate: "",
              ph: "",
              temp: 82,
              dosed: "No",
              notes: "",
            };
          },
          // Phase logic (refined & non-HTML)
          phaseLabel(r) {
            const a = parseFloat(r.ammonia) || 0;
            const n2 = parseFloat(r.nitrite) || 0;
            const n3 = parseFloat(r.nitrate) || 0;
            // Refined basic rules:
            // Phase 3: Both toxic compounds ~0 and nitrate accumulating
            if (a < 0.25 && n2 < 0.25 && n3 >= 5) return "Phase 3";
            // Phase 2: Nitrite present meaningfully OR transitioning down while nitrate still low
            if (n2 >= 0.25 && (a > 0.25 || n3 < 5)) return "Phase 2";
            // Default Phase 1
            return "Phase 1";
          },
          phaseClass(r) {
            const label = this.phaseLabel(r);
            return label === "Phase 1"
              ? "bg-red-600"
              : label === "Phase 2"
              ? "bg-orange-600"
              : "bg-green-600";
          },
          parameterClass(val, key) {
            if (val === "" || val == null) return "";
            if (!window.getParameterStatus) return "";
            const status = window.getParameterStatus(key, val);
            return window.getParameterClass
              ? window.getParameterClass(status)
              : "";
          },
          // Trend helpers
          trendDelta(param, i) {
            if (i === 0) return null;
            const prev = parseFloat(this.readings[i - 1][param]);
            const curr = parseFloat(this.readings[i][param]);
            if (isNaN(prev) || isNaN(curr)) return null;
            const delta = +(curr - prev).toFixed(2);
            return delta;
          },
          trendIcon(param, i) {
            const d = this.trendDelta(param, i);
            if (d === null || d === 0) return d === 0 ? "▬" : "";
            return d > 0 ? "▲" : "▼";
          },
          trendClass(param, i) {
            const d = this.trendDelta(param, i);
            if (d === null || d === 0) return "text-slate-400";
            // For ammonia & nitrite: down good (green), up bad (red)
            if (param === "ammonia" || param === "nitrite") {
              return d < 0 ? "text-green-600" : "text-red-600";
            }
            // For nitrate: up expected (green), down unusual (amber)
            if (param === "nitrate")
              return d > 0 ? "text-green-600" : "text-amber-600";
            // For pH: large swings flagged red, mild change neutral
            if (param === "ph") {
              if (Math.abs(d) >= 0.3) return "text-red-600";
              return "text-slate-500";
            }
            return "text-slate-500";
          },
          // CRUD: Readings
          addReading() {
            if (!this.newReading.date || !this.newReading.day) {
              alert("Please enter date and cycle day");
              return;
            }
            this.readings.push({ id: crypto.randomUUID(), ...this.newReading });
            this.resetNewReading();
          },
          deleteReading(i) {
            if (!confirm("Delete this reading?")) return;
            const removed = this.readings.splice(i, 1)[0];
            this.queueUndo({ type: 'readings', index: i, record: removed }, 'Reading deleted');
          },
          exportToCSV() {
            const header = [
              "Date",
              "Cycle Day",
              "Ammonia",
              "Nitrite",
              "Nitrate",
              "pH",
              "Temp",
              "Dosed",
              "Phase",
              "Notes",
            ];
            let csv = header.join(",") + "\n";
            this.readings.forEach((r) => {
              const phaseTxt = this.phaseLabel(r);
              const row = [
                r.date,
                r.day,
                r.ammonia,
                r.nitrite,
                r.nitrate,
                r.ph,
                r.temp,
                r.dosed,
                phaseTxt,
                r.notes,
              ];
              csv +=
                row
                  .map(
                    (c) => '"' + (c ?? "").toString().replace(/"/g, '""') + '"'
                  )
                  .join(",") + "\n";
            });
            if (this.progressNotes.trim()) {
              csv +=
                '\n"Progress Notes:"\n"' +
                this.progressNotes.replace(/"/g, '""') +
                '"\n';
            }
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "aquarium_cycle_data.csv";
            a.click();
          },
          // Persistence helpers
          persistReadings() {
            localStorage.setItem(
              this.lsKeys.readings,
              JSON.stringify(this.readings)
            );
          },
                  this.updateChart();
                  this.recomputePredictions();
          persistAll() {
            this.persistReadings();
            localStorage.setItem(this.lsKeys.notes, this.progressNotes);
            this.persistWater();
            this.persistAdditions();
            this.persistEnv();
            this.persistSource();
            this.persistBacterial();
            this.persistCritical();
            alert("Data saved");
          },
          clearAll() {
            if (!confirm("Clear ALL saved data?")) return;
            Object.values(this.lsKeys).forEach((k) =>
              localStorage.removeItem(k)
            );
            this.readings = [];
            this.progressNotes = "";
            this.waterChanges = [];
            this.additions = [];
            this.environmentalFactors = [];
            this.waterSources = [];
            this.bacterialHealth = [];
            this.criticalEvents = [];
            this.resetNewReading();
          },
                    // Seed first reading for new tank
          loadAll() {
            const get = (k) => {
              try {
                return JSON.parse(localStorage.getItem(k) || "null");
              } catch {
                return null;
              }
            };
            const r = get(this.lsKeys.readings);
            if (r) this.readings = r;
            const n = localStorage.getItem(this.lsKeys.notes);
            if (n) this.progressNotes = n;
            const w = get(this.lsKeys.water);
            if (w) this.waterChanges = w;
            const a = get(this.lsKeys.additions);
            if (a) this.additions = a;
            const e = get(this.lsKeys.env);
            if (e) this.environmentalFactors = e;
            const s = get(this.lsKeys.source);
            if (s) this.waterSources = s;
            const b = get(this.lsKeys.bacterial);
            if (b) this.bacterialHealth = b;
            const c = get(this.lsKeys.critical);
            if (c) this.criticalEvents = c;
          },
          // Water Changes
          addWaterChange() {
            const n = this.newWaterChange;
            if (!n.date || !n.volume || !n.reason || !n.impact) {
              alert("Fill all water change fields");
              return;
                  if (!confirm("Delete record?")) return;
                  const removed = this.waterChanges.splice(i, 1)[0];
                  this.queueUndo({ type: 'waterChanges', index: i, record: removed }, 'Water change deleted');
            this.waterChanges.push({ id: crypto.randomUUID(), ...n });
            this.newWaterChange = {
              date: "",
              volume: "",
              reason: "",
              impact: "",
            };
          },
          deleteWaterChange(i) {
            if (confirm("Delete record?")) this.waterChanges.splice(i, 1);
          },
          persistWater() {
            localStorage.setItem(
              this.lsKeys.water,
              JSON.stringify(this.waterChanges)
            );
          },
          // Additions
          addAddition() {
            const n = this.newAddition;
            if (!n.date || !n.product || !n.quantity || !n.reason) {
              alert("Fill all addition fields");
              return;
                  if (!confirm("Delete record?")) return;
                  const removed = this.additions.splice(i, 1)[0];
                  this.queueUndo({ type: 'additions', index: i, record: removed }, 'Addition deleted');
            this.additions.push({ id: crypto.randomUUID(), ...n });
            this.newAddition = {
              date: "",
              product: "",
              quantity: "",
              reason: "",
            };
          },
          deleteAddition(i) {
            if (confirm("Delete record?")) this.additions.splice(i, 1);
          },
          persistAdditions() {
            localStorage.setItem(
              this.lsKeys.additions,
              JSON.stringify(this.additions)
            );
          },
          // Environmental
          addEnvironmental() {
            const n = this.newEnvironmental;
            if (!n.date || !n.type || !n.description || !n.impact) {
              alert("Fill all environmental fields");
              return;
                  if (!confirm("Delete record?")) return;
                  const removed = this.environmentalFactors.splice(i, 1)[0];
                  this.queueUndo({ type: 'environmentalFactors', index: i, record: removed }, 'Environmental factor deleted');
            this.newEnvironmental = {
              date: "",
              type: "",
              description: "",
              impact: "",
            };
          },
          deleteEnvironmental(i) {
            if (confirm("Delete record?"))
              this.environmentalFactors.splice(i, 1);
          },
          persistEnv() {
            localStorage.setItem(
              this.lsKeys.env,
              JSON.stringify(this.environmentalFactors)
            );
          },
          // Water source
          addWaterSource() {
            const n = this.newWaterSource;
            if (!n.date || !n.batch || !n.treatment || !n.municipal) {
              alert("Fill all water source fields");
              return;
                  if (!confirm("Delete record?")) return;
                  const removed = this.waterSources.splice(i, 1)[0];
                  this.queueUndo({ type: 'waterSources', index: i, record: removed }, 'Water source deleted');
            this.waterSources.push({ id: crypto.randomUUID(), ...n });
            this.newWaterSource = {
              date: "",
              batch: "",
              treatment: "",
              municipal: "",
            };
          },
          deleteWaterSource(i) {
            if (confirm("Delete record?")) this.waterSources.splice(i, 1);
          },
          persistSource() {
            localStorage.setItem(
              this.lsKeys.source,
              JSON.stringify(this.waterSources)
            );
          },
          // Bacterial
          addBacterial() {
            const n = this.newBacterial;
            if (!n.date || !n.clarity || !n.surface || !n.odor || !n.biofilm) {
              alert("Fill all bacterial fields");
              return;
            }
                  if (!confirm("Delete record?")) return;
                  const removed = this.bacterialHealth.splice(i, 1)[0];
                  this.queueUndo({ type: 'bacterialHealth', index: i, record: removed }, 'Bacterial health record deleted');
            this.newBacterial = {
              date: "",
              clarity: "",
              surface: "",
              odor: "",
              biofilm: "",
            };
          },
          deleteBacterial(i) {
            if (confirm("Delete record?")) this.bacterialHealth.splice(i, 1);
          },
          persistBacterial() {
            localStorage.setItem(
              this.lsKeys.bacterial,
              JSON.stringify(this.bacterialHealth)
            );
          },
          // Critical events
          addCritical() {
            const n = this.newCritical;
            if (!n.date || !n.eventType || !n.reading || !n.significance) {
              alert("Fill all critical event fields");
              return;
                  if (!confirm("Delete record?")) return;
                  const removed = this.criticalEvents.splice(i, 1)[0];
                  this.queueUndo({ type: 'criticalEvents', index: i, record: removed }, 'Critical event deleted');
            this.criticalEvents.push({ id: crypto.randomUUID(), ...n });
            this.newCritical = {
              date: "",
              eventType: "",
              reading: "",
              significance: "",
            };
                // Undo logic
                queueUndo(payload, message) {
                  if (this.undo.timeoutId) clearTimeout(this.undo.timeoutId);
                  this.undo.payload = payload;
                  this.undo.message = message;
                  this.undo.visible = true;
                  this.undo.timeoutId = setTimeout(() => {
                    this.undo.visible = false;
                    this.undo.payload = null;
                  }, this.undo.ttl);
                },
                  performUndo() {
                    if (!this.undo.payload) return;
                    const { type, index, record } = this.undo.payload;
                    if (Array.isArray(this[type])) {
                      this[type].splice(index, 0, record);
                    }
                    this.dismissUndo();
                  },
                  dismissUndo() {
                    if (this.undo.timeoutId) clearTimeout(this.undo.timeoutId);
                    this.undo.visible = false;
                    this.undo.payload = null;
                  },
                // Tank / Namespacing
                initTanks() {
                  const stored = JSON.parse(localStorage.getItem('aquariumTankList') || 'null');
                  if (Array.isArray(stored) && stored.length) {
                    this.tankList = stored;
                  } else {
                    this.tankList = ['Default Tank'];
                    localStorage.setItem('aquariumTankList', JSON.stringify(this.tankList));
                  }
                  this.currentTank = this.tankList[0];
                  this.updateNamespace();
                  this.loadAll();
                },
                updateNamespace() {
                  const ns = this.currentTank.replace(/\s+/g,'_').toLowerCase();
                  this.tankStorageNamespace = ns;
                  this.lsKeys = {
                    readings: `aquarium_${ns}_cycleData`,
                    notes: `aquarium_${ns}_progressNotes`,
                    water: `aquarium_${ns}_waterChanges`,
                    additions: `aquarium_${ns}_tankAdditions`,
                    env: `aquarium_${ns}_environmentalFactors`,
                    source: `aquarium_${ns}_waterSource`,
                    bacterial: `aquarium_${ns}_bacterialHealth`,
                    critical: `aquarium_${ns}_criticalEvents`,
                  };
                },
                saveTankList() {
                  localStorage.setItem('aquariumTankList', JSON.stringify(this.tankList));
                },
                addTank() {
                  const name = (this.newTankName || '').trim();
                  if (!name) { alert('Enter a tank name'); return; }
                  if (this.tankList.includes(name)) { alert('Tank already exists'); return; }
                  this.tankList.push(name);
                  this.saveTankList();
                  this.currentTank = name;
                  this.newTankName = '';
                },
                duplicateTank() {
                  if (!this.currentTank) return;
                  const base = this.currentTank + ' Copy';
                  let name = base; let i=2;
                  while (this.tankList.includes(name)) { name = base + ' ' + i++; }
                  this.tankList.push(name);
                  this.saveTankList();
                  // Copy data from current into new tank namespace
                  const oldNs = this.tankStorageNamespace;
                  const newNs = name.replace(/\s+/g,'_').toLowerCase();
                  const mappings = ['cycleData','progressNotes','waterChanges','tankAdditions','environmentalFactors','waterSource','bacterialHealth','criticalEvents'];
                  mappings.forEach(suffix => {
                    const oldKey = `aquarium_${oldNs}_${suffix}`;
                    const newKey = `aquarium_${newNs}_${suffix}`;
                    const val = localStorage.getItem(oldKey);
                    if (val) localStorage.setItem(newKey, val);
                  });
                  this.currentTank = name;
                },
                deleteTank() {
                  if (this.tankList.length <=1) { alert('Cannot delete last tank'); return; }
                  if (!confirm('Delete tank "' + this.currentTank + '" and all its data?')) return;
                  const ns = this.tankStorageNamespace;
                  const keys = Object.values({
                    readings: `aquarium_${ns}_cycleData`,
                    notes: `aquarium_${ns}_progressNotes`,
                    water: `aquarium_${ns}_waterChanges`,
                    additions: `aquarium_${ns}_tankAdditions`,
                    env: `aquarium_${ns}_environmentalFactors`,
                    source: `aquarium_${ns}_waterSource`,
                    bacterial: `aquarium_${ns}_bacterialHealth`,
                    critical: `aquarium_${ns}_criticalEvents`,
                  });
                  keys.forEach(k=>localStorage.removeItem(k));
                  this.tankList = this.tankList.filter(t=>t!==this.currentTank);
                  this.saveTankList();
                  this.currentTank = this.tankList[0];
                },
                // JSON Import/Export
                exportToJSON() {
                  const payload = {
                    meta: { version: 1, exportedAt: new Date().toISOString(), tank: this.currentTank },
                    tankList: this.tankList,
                    currentTank: this.currentTank,
                    readings: this.readings,
                    progressNotes: this.progressNotes,
                    waterChanges: this.waterChanges,
                    additions: this.additions,
                    environmentalFactors: this.environmentalFactors,
                    waterSources: this.waterSources,
                    bacterialHealth: this.bacterialHealth,
                    criticalEvents: this.criticalEvents,
                  };
                  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
                  const a = document.createElement('a');
                  a.href = URL.createObjectURL(blob);
                  a.download = `aquarium_${this.tankStorageNamespace}_data.json`;
                  a.click();
                },
                triggerImportJSON() {
                  this.$refs.importInput.click();
                },
                handleImportJSON(e) {
                  const file = e.target.files[0];
                  if (!file) return;
                  const reader = new FileReader();
                  reader.onload = () => {
                    try {
                      const data = JSON.parse(reader.result);
                      if (!data.readings) throw new Error('Invalid file');
                      if (!confirm('Replace current tank data with imported content?')) return;
                      // If tank list present, merge new tanks
                      if (Array.isArray(data.tankList)) {
                        data.tankList.forEach(t=>{ if(!this.tankList.includes(t)) this.tankList.push(t); });
                        this.saveTankList();
                      }
                      // If tank names differ, import just into current tank
                      this.readings = data.readings || [];
                      this.progressNotes = data.progressNotes || '';
                      this.waterChanges = data.waterChanges || [];
                      this.additions = data.additions || [];
                      this.environmentalFactors = data.environmentalFactors || [];
                      this.waterSources = data.waterSources || [];
                      this.bacterialHealth = data.bacterialHealth || [];
                      this.criticalEvents = data.criticalEvents || [];
                      this.persistAll();
                      this.updateChart();
                      this.recomputePredictions();
                      alert('Import complete');
                    } catch(err) {
                      alert('Import failed: ' + err.message);
                    } finally {
                      e.target.value = '';
                    }
                  };
                  reader.readAsText(file);
                },
                // Chart Logic
                setupChart() {
                  const ctx = document.getElementById('cycleChart');
                  if (!ctx) return;
                  const phasePlugin = {
                    id: 'phaseShading',
                    beforeDraw: (chart) => {
                      const { ctx, chartArea, scales } = chart;
                      if (!chartArea) return;
                      const x = scales.x;
                      const phases = [
                        { label: 'P1', start: 1, end: 14, color: 'rgba(220,38,38,0.08)' },
                        { label: 'P2', start: 14, end: 28, color: 'rgba(234,88,12,0.08)' },
                        { label: 'P3', start: 28, end: 999, color: 'rgba(16,185,129,0.08)' },
                      ];
                      ctx.save();
                      phases.forEach(p => {
                        const xStart = x.getPixelForValue(p.start);
                        const xEnd = x.getPixelForValue(p.end);
                        ctx.fillStyle = p.color;
                        ctx.fillRect(xStart, chartArea.top, xEnd - xStart, chartArea.bottom - chartArea.top);
                      });
                      ctx.restore();
                    }
                  };
                  this.chart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                      responsive: true,
                      interaction: { mode: 'index', intersect: false },
                      stacked: false,
                      plugins: { legend: { position: 'bottom' } },
                      scales: {
                        x: { title: { display: true, text: 'Cycle Day' } },
                        ammonia: { type: 'linear', position: 'left', title:{display:true,text:'Ammonia/Nitrite (ppm)'}, min:0 },
                        nitrate: { type: 'linear', position: 'right', title:{display:true,text:'Nitrate (ppm)'}, grid:{drawOnChartArea:false}, min:0 },
                        ph: { type: 'linear', position: 'right', title:{display:true,text:'pH'}, grid:{drawOnChartArea:false}, min:5, max:10 },
                      },
                    },
                    plugins: [phasePlugin]
                  });
                },
                updateChart() {
                  if (!this.chart) return;
                  const labels = this.readings.map(r=>Number(r.day));
                  const dsBase = (label, data, color, yAxisID) => ({
                    label, data, borderColor: color, backgroundColor: color, tension: 0.2, yAxisID, spanGaps: true, pointRadius: 3, pointHoverRadius: 5
                  });
                  const ammonia = this.readings.map(r=> parseFloat(r.ammonia)||null);
                  const nitrite = this.readings.map(r=> parseFloat(r.nitrite)||null);
                  const nitrate = this.readings.map(r=> parseFloat(r.nitrate)||null);
                  const ph = this.readings.map(r=> parseFloat(r.ph)||null);
                  this.chart.data.labels = labels;
                  this.chart.data.datasets = [
                    dsBase('Ammonia', ammonia, 'rgba(239,68,68,1)', 'ammonia'),
                    dsBase('Nitrite', nitrite, 'rgba(249,115,22,1)', 'ammonia'),
                    dsBase('Nitrate', nitrate, 'rgba(34,197,94,1)', 'nitrate'),
                    dsBase('pH', ph, 'rgba(139,92,246,1)', 'ph'),
                  ];
                  this.chart.update('none');
                },
                refreshChart() { this.updateChart(); },
                // Prediction helpers
                linearRegression(points) {
                  if (points.length < 2) return null;
                  const n = points.length;
                  let sumX=0,sumY=0,sumXY=0,sumX2=0;
                  points.forEach(([x,y])=>{ sumX+=x; sumY+=y; sumXY+=x*y; sumX2+=x*x; });
                  const denom = (n*sumX2 - sumX*sumX);
                  if (denom === 0) return null;
                  const m = (n*sumXY - sumX*sumY)/denom;
                  const b = (sumY - m*sumX)/n;
                  return { m, b };
                },
                formatPredictionRate(m) { if (m===null || m===undefined) return '—'; return (m>0?'+':'') + m.toFixed(3) + ' /day'; },
                estimateDate(days) {
                  if (days===null || days===undefined || !isFinite(days)) return null;
                  const lastDateStr = this.readings.length ? this.readings[this.readings.length-1].date : this.today();
                  const d = new Date(lastDateStr + 'T00:00:00');
                  d.setDate(d.getDate() + Math.max(0, Math.round(days)));
                  return d.toISOString().split('T')[0];
                },
                recomputePredictions() {
                  const recent = (key, max=10) => {
                    const pts = this.readings.filter(r=> r[key]!=='' && r[key]!==null)
                      .slice(-max)
                      .map(r=>[Number(r.day), parseFloat(r[key])]);
                    return pts.filter(p=>!isNaN(p[0]) && !isNaN(p[1]));
                  };
                  const build = (key, targetValue, comparison='<=') => {
                    const pts = recent(key);
                    const lr = this.linearRegression(pts);
                    const lastVal = pts.length? pts[pts.length-1][1] : null;
                    let daysToTarget = null; let projectedDate = null;
                    if (lr && lastVal!==null) {
                      const m = lr.m; const b = lr.b;
                      if (m!==0) {
                        const xTarget = (targetValue - b)/m; // day at which we expect target
                        const lastDay = pts[pts.length-1][0];
                        daysToTarget = xTarget - lastDay;
                        if (daysToTarget < 0) daysToTarget = 0;
                        projectedDate = this.estimateDate(daysToTarget);
                      }
                    }
                    return {
                      rate: lr? lr.m : null,
                      rateDisplay: this.formatPredictionRate(lr? lr.m : null),
                      daysToTarget: (daysToTarget!==null && isFinite(daysToTarget))? daysToTarget : null,
                      daysToTargetDisplay: (daysToTarget!==null && isFinite(daysToTarget))? daysToTarget.toFixed(1) : '—',
                      projectedDate,
                    };
                  };
                  // Ammonia & Nitrite targets 0.25 ppm
                  this.predictions.ammonia = build('ammonia', 0.25, '<=');
                  this.predictions.nitrite = build('nitrite', 0.25, '<=');
                  // Nitrate: project +10 ppm increase from last value
                  const nitratePts = recent('nitrate');
                  const nitrateLr = this.linearRegression(nitratePts);
                  if (nitrateLr && nitratePts.length) {
                    const lastDay = nitratePts[nitratePts.length-1][0];
                    const lastVal = nitratePts[nitratePts.length-1][1];
                    const target = lastVal + 10;
                    let days = null; let projectedDate = null;
                    if (nitrateLr.m>0) {
                      const xTarget = (target - nitrateLr.b)/nitrateLr.m;
                      days = xTarget - lastDay;
                      projectedDate = this.estimateDate(days);
                    }
                    this.predictions.nitrate = {
                      rate: nitrateLr.m,
                      rateDisplay: this.formatPredictionRate(nitrateLr.m),
                      daysToPlus10: days,
                      daysToPlus10Display: (days!==null && isFinite(days))? days.toFixed(1):'—',
                      projectedDate,
                    };
                  } else {
                    this.predictions.nitrate = { rate:null, rateDisplay:'—', daysToPlus10:null, daysToPlus10Display:'—', projectedDate:null };
                  }
                },
              },
          },
          deleteCritical(i) {
          <script>
            // Simple fade transition support
          </script>
            if (confirm("Delete record?")) this.criticalEvents.splice(i, 1);
          },
          persistCritical() {
            localStorage.setItem(
              this.lsKeys.critical,
              JSON.stringify(this.criticalEvents)
            );
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
